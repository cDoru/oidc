sudo: required
services:
  - docker
dist: trusty
language: csharp
mono: none
dotnet: 1.0.1
solution: OpenIdConnect.sln
addons:
  apt:
    packages: 
  artifacts:
    s3_region: eu-west-1
    paths:
    - oidc.zip
    bucket: cmsd2-artifacts
    target_paths: oidc/$TRAVIS_BUILD_NUMBER
    debug: true
before_install:
  - pip install --user awscli
  - export PATH=$PATH:$HOME/.local/bin
before_script:
- npm install -g bower
install:
- dotnet restore OpenIdConnect.sln
script:
- dotnet build
- dotnet publish src/OpenIdConnectServer/OpenIdConnectServer.csproj -f netcoreapp1.0 -o target
before_deploy:
  cd src/OpenIdConnectServer/target
deploy:
  provider: script
  script: env AWS_ACCESS_KEY_ID=$ARTIFACTS_KEY AWS_SECRET_ACCESS_KEY=$ARTIFACTS_SECRET CLUSTER_NAME=cmsd2-ecs SERVICE_NAME=oidc-service TASK_FAMILY=oidc IMAGE_NAME=oidc IMAGE_TAG=$TRAVIS_BUILD_NUMBER AWS_DEFAULT_REGION=eu-west-1 DOCKER_REGISTRY=197315730647.dkr.ecr.eu-west-1.amazonaws.com /bin/bash $TRAVIS_BUILD_DIR/scripts/deploy.sh
  skip_cleanup: true
  on:
    branch: master
env:
  global:
  - AWS_DEFAULT_REGION: eu-west-1
  - ARTIFACTS_KEY: AKIAJQ7AB5KKVNZLX3TQ
  - ARTIFACTS_BUCKET: cmsd2-artifacts
  - secure: CDdMQZ0Mda/kKe/clTao2r6YEpyYp+waL+hiI5Wbx9/DylO8puTy/4wvX7KWCaWaGgDuGpfxWN1GBV8140lr1Vl6qvdCLNe9PtYyh1T9WPcnpOSzjy23aNq0Y3yPoQB+oiw6YnGy1NZTqnlXDsent8di1AymCBocWPEd7hmaCNjZLrQpJM2kDDlFqjRLxNcFT19+scojhNjw+xeEe1FsvaB4jXuMXSEuz/UPws88C6MYiTewrX55p92/QILzZx9DBBlXche7vvRoqCSjaJJp8SaXUmGhvSI9Z6aPwbQgPGWKZKznEF2ImgWHh+Spikn+FBtDYswLShRq5I/FMFQrC0JX7FO17LLrIAgrGtx4YSpOTaadY31pyoyE/lC7T7A8WtkivoxMKM6GAW/1vyRzllIQrTaOvrwaJiQCDO0VfcGyCdtwaiwv6faKGYD45GGEVqm4HpqP61G3QMRWvuVBKA13uRlU/aS5DuYMcxITZ0Fr6LyxCcVXq1AjVD+buRKTyY9ug+UFC1tS4NPo8NvqzD5NoGdtmPoXNXYIZIquwnuARzBpiqC55iPAcP/LYVcPDhHlNE87PxypS6S3xN5fS/SUcqahyuLWvpmtTYkDiYrlLp4EZNdl2idzKfFuO4Brxi3gimWDvK7nDuJbECatPa0RN39ivf5vA09fWhpNVdk=
